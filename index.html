<!DOCTYPE html>
<html lang="en">
<head>
<title>Aergo Smart Contract Editor</title>
<style type="text/css" media="screen">

html, body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  background-color: lightgray;
  height: 100%;
}

.navbar {
  overflow: hidden;
}

.logo {
  margin: 10px 20px;
}

#editor {
  position: relative;
  margin: 0;
  padding: 0;
  min-height: 100%;
}

#buttons {
  display: flex;
  float: right;
  margin-right: 10px;
}

.btn {
  border: none;
  color: white;
  padding: 14px 28px;
  margin-top: 10px;
  font-size: large;
  cursor: pointer;
}

.btn-left {
  border-radius: 5px 0px 0px 5px;
}

.btn-right {
  border-radius: 0px 5px 5px 0px;
  border-left: 1px solid #e88aba;
  padding: 14px;
}

.dropdown {
  display: inline-block;
}

.dropdown-content {
  display: none;
  position: absolute;
  background-color: #f1f1f1;
  min-width: 160px;
  z-index: 1;
  right: 10px;
}

.dropdown-content a {
  color: black;
  padding: 12px 16px;
  text-decoration: none;
  display: block;
}

.dropdown-content a:hover {background-color: #ddd}

.dropdown:hover .dropdown-content {
  display: block;
}

.btn:hover, .dropdown:hover .btn {
  background-color: #cc1873;
}


.aergo {background-color: #ef077d;} /* Pink */
.aergo:hover {background-color: #cc1873;}

.success {background-color: #4CAF50;} /* Green */
.success:hover {background-color: #46a049;}

.info {background-color: #2196F3;} /* Blue */
.info:hover {background: #0b7dda;}

.warning {background-color: #ff9800;} /* Orange */
.warning:hover {background: #e68a00;}

.danger {background-color: #f44336;} /* Red */
.danger:hover {background: #da190b;}

.default {background-color: #e7e7e7; color: black;} /* Gray */
.default:hover {background: #ddd;}

</style>
<script src="https://code.jquery.com/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="https://unpkg.com/@herajs/client@0.21.0/dist/herajs.min.js" type="text/javascript"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>

<div class="navbar">
<img class="logo" src="https://testnet.aergoscan.io/b8ad10fbfc4ce11c608606969a920292.svg"/>

<div id="buttons">
<button onclick="deploy()" class="btn btn-left aergo" id="deploy">Deploy</button>
<div class="dropdown">
  <button class="btn btn-right aergo">
    <i class="fa fa-caret-down"></i>
  </button>
  <div class="dropdown-content">
    <a href="#" onclick="redeploy()">Redeploy</a>
  </div>
</div>
</div>

</div>

<div id="editor">function test()
  return 'Hello World!'
end

abi.register(test)</div>

<script>

var editor = ace.edit("editor");
editor.setTheme("ace/theme/tomorrow_night_bright");
editor.session.setMode("ace/mode/lua");
document.getElementById('editor').style.fontSize='18px';

function aergoConnectCall(action, responseType, data) {
  return new Promise((resolve, reject) => {
    window.addEventListener(responseType, function(event) {
      if ('error' in event.detail) {
        reject(event.detail.error);
      } else {
        resolve(event.detail);
      }
    }, { once: true });
    window.postMessage({
      type: 'AERGO_REQUEST',
      action: action,
      data: data,
    }, '*');
  });
}

async function getActiveAccount() {
  const result = await aergoConnectCall('ACTIVE_ACCOUNT', 'AERGO_ACTIVE_ACCOUNT', {});
  return result.account.address;
}

async function startTxSendRequest(txdata) {
  const result = await aergoConnectCall('SEND_TX', 'AERGO_SEND_TX_RESULT', txdata);
  console.log('AERGO_SEND_TX_RESULT', result);
  alert(result.hash);
  // TODO: retrieve the txn receipt and redirect to the aergoscan page
}


function convertPayload(encoded) {

/*
  var args = [];
  const text = encodeBuffer(decodeToBytes(encoded, 'base58'), 'ascii');
  const match = text.match(new RegExp(/({"name":"constructor","arguments":\[.*?\]})/));
  if (match) {
    args = JSON.parse(match[1]);
  }

  const contract = Contract.fromCode(encoded);
  return encodeBuffer(contract.asPayload(args.flat()), 'base64');
*/

  const contract = window.herajs.Contract.fromCode(encoded);
  return window.btoa(contract.asPayload([]));

}


async function process_deploy(contract_address){

  var content = editor.getValue();

  var account_address = await getActiveAccount();

  $.ajax({
    type: 'POST',
    url: 'https://luac.aergo.io/compile',
    crossDomain: true,
    data: content,
    dataType: 'text',
    success: function(responseData, textStatus, jqXHR) {
        var value = responseData;
        if (value.substring(0,8) != 'result: '){
          alert('error compiling the contract');
          return;
        }
        var txdata = {
          type: 6,
          from: account_address,
          to: contract_address,
          amount: 0,
          payload: convertPayload(value.substring(8).trim())
        }
        startTxSendRequest(txdata);
    },
    error: function (responseData, textStatus, errorThrown) {
        alert('POST failed.' + responseData + textStatus + errorThrown);
    }
  });

}

function deploy(){
  process_deploy(null);
}

function redeploy() {
  alert('TODO: redeploy');
  // TODO: get the contract address from the user
  // process_deploy(contract_address);
}

</script>
</body>
</html>
